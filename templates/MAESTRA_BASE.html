<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="shortcut icon" href="/static/img/icono.png" type="image/x-icon">
    <link rel="stylesheet" href="/static/css/common_styles/bootstrap.min.css" />
    <link rel="stylesheet" href="/static/css/common_styles/all.min.css" />
    <link rel="stylesheet" href="/static/css/common_styles/fonts.css" />
    
    <!-- <link rel="stylesheet" href="/static/css/common_styles/fontawesome.min.css" /> -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/7.0.0/css/all.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/remixicon/3.5.0/remixicon.css" crossorigin="">
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/@phosphor-icons/web@2.1.1/src/regular/style.css"/>
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/@phosphor-icons/web@2.1.1/src/fill/style.css"/>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.13.1/font/bootstrap-icons.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/boxicons@latest/css/boxicons.min.css">

    <link rel="stylesheet" href="/static/css/common_styles/common_style.css" />
    {% block estilos_html %}
    {% endblock %}
    <title>
        {% block titulo_html %}
        {% endblock %} | Academico
    </title>
</head>

<body class="general_body">

    {% block body_html %}
    {% endblock %}

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.min.js"
        integrity="sha384-0pUGZvbkm6XF6gxjEnlmuGrJXVbNuzT9qBBavbLwCsOGabYfZo0T0to5eqruptLy"
        crossorigin="anonymous"></script>
    <script src="/static/js/common_scripts/common_script.js"></script>
    <script src="/static/js/modal.js"></script>

    <script>
        function getRgbArray(color) {
            // Caso: color(srgb r g b)
            if (color.startsWith("color(srgb")) {
                let parts = color.match(/[-+]?\d*\.?\d+/g).map(Number);
                return [
                    Math.round(parts[0] * 255),
                    Math.round(parts[1] * 255),
                    Math.round(parts[2] * 255)
                ];
            }

            // Caso: rgba / rgb
            let rgbMatch = color.match(/\d+(\.\d+)?/g);
            if (rgbMatch) {
                return rgbMatch.slice(0, 3).map(Number);
            }

            // Caso: hex o hsl → usar canvas para convertir
            let ctx = document.createElement("canvas").getContext("2d");
            ctx.fillStyle = color;
            let computed = ctx.fillStyle; // siempre en rgb/hex
            let values = computed.match(/\d+(\.\d+)?/g);
            return values ? values.slice(0, 3).map(Number) : [0, 0, 0];
        }

        function ajustarColorTexto(el, umbral = 128) {
            try {
                let bgColor = window.getComputedStyle(el).backgroundColor;
                let [r, g, b] = getRgbArray(bgColor);

                // fórmula de luminosidad perceptual (mejor que promedio simple)
                let brillo = (0.299 * r + 0.587 * g + 0.114 * b);

                el.style.color = brillo > umbral ? "black" : "white";
            } catch (err) {
                console.warn("Error al ajustar color:", err);
                el.style.color = "black"; // fallback
            }
        }

        function pintarElemento(e) {
            document.querySelectorAll(e).forEach(div => {
                if (div) {
                    ajustarColorTexto(div);
                }
            });
        }
        
        function update_bd_table( tabla , columnas , valores , where , where_v ) {
            fetch('/api_bd_update', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    tabla:    tabla,
                    columnas: columnas ,
                    valores:  valores ,
                    where:    where ,
                    where_v : where_v
                })
            })
            .then(response => {
                if (!response.ok) throw new Error("Error al actualizar");
                return response.json();
            })
            .then(data => {
                console.log(data);
            })
            .catch(err => {
                alert("Error al actualizar valor");
                console.error(err);
            });
        }
        
        function update_column_table_id( tabla , columna , valor , id ) {
            fetch('/update_column_table_id', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    tabla: tabla,
                    columna: columna ,
                    valor: valor ,
                    id : id
                })
            })
            .then(response => {
                if (!response.ok) throw new Error("Error al actualizar");
                return response.json();
            })
            .then(data => {
                console.log(data);
            })
            .catch(err => {
                alert("Error al actualizar valor");
                console.error(err);
            });
        }

        document.querySelectorAll('.tarea_nom').forEach(div => {
            div.addEventListener('dblclick', () => {
                if (div.querySelector('input')) return;  // evitar múltiples inputs

                const currentText = div.textContent.trim();
                const input = document.createElement('input');
                input.type = 'text';
                input.value = currentText;
                input.style.width = '100%';
                input.style.fontFamily = 'inherit';
                input.style.fontSize = 'inherit';
                input.style.border = 'none';
                input.style.outline = 'none';
                // 
                // input.style.background = 'transparent';

                div.innerHTML = '';
                div.appendChild(input);
                input.focus();

                pintarElemento(' .tarea input ');


                const guardar = () => {
                    const nuevoTexto = input.value.trim();
                    if (nuevoTexto && nuevoTexto !== currentText) {
                        const id = div.dataset.id;
                        update_column_table_id("tarea", "nombre", nuevoTexto, id);
                    }
                    div.textContent = nuevoTexto || currentText;
                };

                input.addEventListener('blur', guardar);
                input.addEventListener('keydown', e => {
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        input.blur();
                    }
                });
            });
        });
        
        function update_name_element_bd_table(selector , tabla , columna , datasetKey) {
            document.querySelectorAll(selector).forEach(div => {
                div.addEventListener('dblclick', () => {
                    if (div.querySelector('.inputUpdateText')) return;  // evitar múltiples inputs

                    const currentText = div.textContent.trim();
                    const input = document.createElement('input');
                    input.classList.add('inputUpdateText');
                    input.type = 'text';
                    input.value = currentText;
                    input.style.width = '100%';
                    input.style.minWidth = '50px';
                    input.style.fontFamily = 'inherit';
                    input.style.fontSize = 'inherit';
                    input.style.border = 'none';
                    input.style.outline = 'none';
                    input.style.backgroundColor = window.getComputedStyle(div).backgroundColor;

                    div.innerHTML = '';
                    div.appendChild(input);
                    input.focus();
                    input.select();

                    pintarElemento(` ${selector} input.inputUpdateText `);

                    const guardar = () => {
                        const nuevoTexto = input.value.trim();
                        if (nuevoTexto && nuevoTexto !== currentText) {
                            const valor = div.dataset[datasetKey];
                            update_column_table_id(tabla, columna, nuevoTexto, valor);
                        }
                        div.textContent = nuevoTexto || currentText;
                    };

                    input.addEventListener('blur', guardar);
                    input.addEventListener('keydown', e => {
                        if (e.key === 'Enter') {
                            e.preventDefault();
                            input.blur();
                        }
                    });
                });
            });
        }

        function cssColorToHex(colorStr) {
            if (!colorStr) return '#000000';

            colorStr = colorStr.trim().toLowerCase();

            // #abc, #aabbcc, #rrggbbaa
            if (colorStr.startsWith('#')) {
                if (colorStr.length === 4) {
                return '#' + [...colorStr.slice(1)].map(c => c + c).join('');
                }
                if (colorStr.length === 7) return colorStr;
                if (colorStr.length === 9) return '#' + colorStr.slice(1, 7); // descarta alfa
            }

            // rgb() o rgba()
            const m = colorStr.match(
                /^rgba?\(\s*([\d.]+)\s*[, ]\s*([\d.]+)\s*[, ]\s*([\d.]+)(?:\s*[,/]\s*([\d.]+))?\s*\)$/
            );
            if (m) {
                const toHex = n => Math.max(0, Math.min(255, Math.round(+n))).toString(16).padStart(2,'0');
                return '#' + toHex(m[1]) + toHex(m[2]) + toHex(m[3]);
            }

            // fallback
            return '#000000';
        }

        function update_color_element_bd_table(selector, tabla, datasetKey) {
            document.querySelectorAll(selector).forEach(div => {
                div.style.position = 'relative';
                if (div.querySelector('.inputUpdateColor')) return; // evitar duplicados

                const id = div.dataset[datasetKey];
                const colorActual = cssColorToHexAdvanced(window.getComputedStyle(div).backgroundColor);
                
                const input = document.createElement('input');
                input.type = 'color';
                input.classList.add('inputUpdateColor');

                input.style.backgroundColor = colorActual;
                input.value = colorActual; // color inicial
                // console.log('bg',window.getComputedStyle(div).backgroundColor);
                // console.log('value',input.value);
                input.dataset.id = id;
                div.appendChild(input);

                // Click en el div abre el selector
                // div.addEventListener('click', () => {
                //     input.click();
                // });

                // Cuando el usuario elige un color
                input.addEventListener('input', () => {
                    const newColor = input.value;

                    // aplicar al div visible
                    div.style.backgroundColor = newColor;
                    ajustarColorTexto(div);

                    // actualizar en BD
                    update_column_table_id(tabla, "color", newColor, id);

                });
            });
        }

        function cssColorToHexAdvanced(color) {
            if (color.startsWith("color(srgb")) {
                // extraer números
                let parts = color.match(/[-+]?\d*\.?\d+/g).map(Number);
                // srgb está normalizado 0-1 → convierto a 0-255
                let r = Math.round(parts[0] * 255);
                let g = Math.round(parts[1] * 255);
                let b = Math.round(parts[2] * 255);

                return "#" + [r, g, b]
                    .map(x => x.toString(16).padStart(2, "0"))
                    .join("");
            }

            // fallback → usa canvas que soporta rgb(), hsl(), hex...
            let ctx = document.createElement("canvas").getContext("2d");
            ctx.fillStyle = color;
            return ctx.fillStyle;
        }

        function update_color_element_bd_where(selector, tabla, whereClause , datasetKeys) {
            document.querySelectorAll(selector).forEach(div => {
                div.style.position = 'relative';
                if (div.querySelector('.inputUpdateColor')) return; // evitar duplicados

                const whereValues = datasetKeys.map(key => div.dataset[key]);
                const colorActual = cssColorToHexAdvanced(window.getComputedStyle(div).backgroundColor);
                // console.log('color',window.getComputedStyle(div).backgroundColor);
                // console.log('t',cssColorToHex(window.getComputedStyle(div).backgroundColor));
                const input = document.createElement('input');
                input.type = 'color';
                input.classList.add('inputUpdateColor');

                input.style.backgroundColor = colorActual;
                input.value = colorActual;
                div.appendChild(input);

                // Click en el div abre el selector
                // div.addEventListener('click', () => {
                //     input.click();
                // });

                // Cuando el usuario elige un color
                input.addEventListener('input', () => {
                    const newColor = input.value;

                    // aplicar al div visible
                    div.style.backgroundColor = newColor;
                    ajustarColorTexto(div);
                    
                    // actualizar en BD
                    update_bd_table(tabla, ["color"], [newColor], whereClause , whereValues);
                    
                });
            });
        }


    </script>

    {% block scripts_html %}
    {% endblock %}

</body>

</html>