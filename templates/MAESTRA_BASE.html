<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="shortcut icon" href="/static/img/icono.png" type="image/x-icon">
    <link rel="stylesheet" href="/static/css/common_styles/bootstrap.min.css" />
    <link rel="stylesheet" href="/static/css/common_styles/all.min.css" />
    <link rel="stylesheet" href="/static/css/common_styles/fonts.css" />

    <!-- <link rel="stylesheet" href="/static/css/common_styles/fontawesome.min.css" /> -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/7.0.0/css/all.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/remixicon/3.5.0/remixicon.css" crossorigin="">
    <link rel="stylesheet" type="text/css"
        href="https://cdn.jsdelivr.net/npm/@phosphor-icons/web@2.1.1/src/regular/style.css" />
    <link rel="stylesheet" type="text/css"
        href="https://cdn.jsdelivr.net/npm/@phosphor-icons/web@2.1.1/src/fill/style.css" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.13.1/font/bootstrap-icons.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/boxicons@latest/css/boxicons.min.css">

    <style>
        :root {
            --color-border1: 1px solid #ffffff4f;

            --color1: {{ main_paleta.color1 }};
            --color2: {{ main_paleta.color2 }};
            --color3: {{ main_paleta.color3 }};
            --color4: {{ main_paleta.color4 }};
            --color5: {{ main_paleta.color5 }};
            --colorbg1: {{ main_paleta.colorbg1 }};
            --colorbg2: {{ main_paleta.colorbg2 }};
            --colorbg3: {{ main_paleta.colorbg3 }};

           

            /* 
            --color1: #161a2c;
            --color2: #6422ff;
            --color3: #00ADB5;
            --colorbg2: color-mix(in srgb, var(--colorbg1) 100%, black 75%);
            --colorbg3: color-mix(in srgb, var(--colorbg1) 100%, #ffffff 5%); */



            /* --color-r: color-mix(in srgb, white 0%, #ff0000 100%);
            --color-g: color-mix(in srgb, white 0%, #00ff00 100%);
            --color-b: color-mix(in srgb, white 0%, #0000ff 100%); 
            
            
            --color-r: #ff0000 ;
            --color-g: #00ff00 ;
            --color-b: #0000ff ; 
            
            
            --color-base: #2885ff;
            --color1:   color-mix(in srgb, var(--color-base) 100%, #222222 50%);
            --color2:   color-mix(in srgb, var(--color-base) 100%, var(--color-b) 50%);
            --color3:   color-mix(in srgb, var(--color-base) 100%, var(--color-g) 50%);
            --color4:   color-mix(in srgb, var(--color-base) 100%, #5d5d5d 50%);
            --color5:   color-mix(in srgb, var(--color-base) 100%, var(--color-r) 50%);
            --colorbg1: color-mix(in srgb, var(--color-base) 25%, #171717 100%);
            --colorbg2: color-mix(in srgb, var(--color-base) 25%, #000000 100%);
            --colorbg3: color-mix(in srgb, var(--color-base) 25%, #242424 100%);  */

        }
    </style>
    <link rel="stylesheet" href="/static/css/common_styles/common_style.css" />
    {% block estilos_html %}
    {% endblock %}
    <title>
        {% block titulo_html %}
        {% endblock %} | Academico
    </title>
</head>

<body class="general_body">

    {% block body_html %}
    {% endblock %}

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.min.js"
        integrity="sha384-0pUGZvbkm6XF6gxjEnlmuGrJXVbNuzT9qBBavbLwCsOGabYfZo0T0to5eqruptLy"
        crossorigin="anonymous"></script>
    <script src="/static/js/common_scripts/common_script.js"></script>
    <script src="/static/js/modal.js"></script>

    <script>
        function getRgbArray(color) {
            // Caso: color(srgb r g b)
            if (color.startsWith("color(srgb")) {
                let parts = color.match(/[-+]?\d*\.?\d+/g).map(Number);
                return [
                    Math.round(parts[0] * 255),
                    Math.round(parts[1] * 255),
                    Math.round(parts[2] * 255)
                ];
            }

            // Caso: rgba / rgb
            let rgbMatch = color.match(/\d+(\.\d+)?/g);
            if (rgbMatch) {
                return rgbMatch.slice(0, 3).map(Number);
            }

            // Caso: hex o hsl → usar canvas para convertir
            let ctx = document.createElement("canvas").getContext("2d");
            ctx.fillStyle = color;
            let computed = ctx.fillStyle; // siempre en rgb/hex
            let values = computed.match(/\d+(\.\d+)?/g);
            return values ? values.slice(0, 3).map(Number) : [0, 0, 0];
        }

        function ajustarColorTexto(el, umbral = 128) {
            try {
                let bgColor = window.getComputedStyle(el).backgroundColor;
                let [r, g, b] = getRgbArray(bgColor);
                let brillo = (0.299 * r + 0.587 * g + 0.114 * b);

                el.style.color = brillo > umbral ? "black" : "white";
            } catch (err) {
                console.warn("Error al ajustar color:", err);
                el.style.color = "black";
            }
        }

        function pintarElemento(e) {
            document.querySelectorAll(e).forEach(div => {
                if (div) {
                    ajustarColorTexto(div);
                    // div.querySelectorAll('*').forEach(sub => {
                    //     ajustarColorTexto(sub);
                    // });
                }
            });
        }

        function update_bd_table(tabla, columnas, valores, where, where_v) {
            fetch('/api_bd_update', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    tabla: tabla,
                    columnas: columnas,
                    valores: valores,
                    where: where,
                    where_v: where_v
                })
            })
            .then(response => {
                if (!response.ok) throw new Error("Error al actualizar");
                return response.json();
            })
            .then(data => {
                console.log(data);
            })
            .catch(err => {
                alert("Error al actualizar valor");
                console.error(err);
            });
        }

        function update_column_table_id(tabla, columna, valor, id) {
            fetch('/update_column_table_id', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    tabla: tabla,
                    columna: columna,
                    valor: valor,
                    id: id
                })
            })
                .then(response => {
                    if (!response.ok) throw new Error("Error al actualizar");
                    return response.json();
                })
                .then(data => {
                    console.log(data);
                })
                .catch(err => {
                    alert("Error al actualizar valor");
                    console.error(err);
                });
        }

        document.querySelectorAll('.tarea_nom').forEach(div => {
            div.addEventListener('dblclick', () => {
                if (div.querySelector('input')) return;  // evitar múltiples inputs

                const currentText = div.textContent.trim();
                const input = document.createElement('input');
                input.type = 'text';
                input.value = currentText;
                input.style.width = '100%';
                input.style.fontFamily = 'inherit';
                input.style.fontSize = 'inherit';
                input.style.border = 'none';
                input.style.outline = 'none';
                // 
                // input.style.background = 'transparent';

                div.innerHTML = '';
                div.appendChild(input);
                input.focus();

                pintarElemento(' .tarea input ');


                const guardar = () => {
                    const nuevoTexto = input.value.trim();
                    if (nuevoTexto && nuevoTexto !== currentText) {
                        const id = div.dataset.id;
                        update_column_table_id("tarea", "nombre", nuevoTexto, id);
                    }
                    div.textContent = nuevoTexto || currentText;
                };

                input.addEventListener('blur', guardar);
                input.addEventListener('keydown', e => {
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        input.blur();
                    }
                });
            });
        });

        function update_name_element_bd_table(selector, tabla, columna, datasetKey) {
            document.querySelectorAll(selector).forEach(div => {
                div.addEventListener('dblclick', () => {
                    div.style.width = '100%';
                    div.style.height = '100%';
                    if (div.querySelector('.inputUpdateText')) return;  // evitar múltiples inputs

                    const currentText = div.textContent.trim();
                    const input = document.createElement('input');
                    input.classList.add('inputUpdateText');
                    input.type = 'text';
                    input.value = currentText;
                    // input.style.minWidth = '50px';
                    // input.style.width =  `${div.offsetWidth + 3}px` ;
                    // input.style.height =  `${div.offsetHeight - 1}px` ;
                    input.style.width = `${div.clientWidth + 3}px`;
                    input.style.height = `${div.clientHeight}px`;
                    input.style.width = '100%';
                    input.style.height = '100%';
                    // input.style.display = 'flex';
                    input.style.fontFamily = 'inherit';
                    input.style.fontSize = 'inherit';
                    input.style.border = 'none';
                    input.style.outline = 'none';
                    input.style.backgroundColor = window.getComputedStyle(div).backgroundColor;

                    div.innerHTML = '';
                    div.appendChild(input);
                    input.focus();
                    input.select();

                    pintarElemento(` ${selector} input.inputUpdateText `);

                    const guardar = () => {
                        const nuevoTexto = input.value.trim();
                        if (nuevoTexto && nuevoTexto !== currentText) {
                            const valor = div.dataset[datasetKey];
                            update_column_table_id(tabla, columna, nuevoTexto, valor);
                        }
                        div.textContent = nuevoTexto || currentText;
                        div.style.removeProperty('width');
                        div.style.removeProperty('height');
                    };

                    input.addEventListener('blur', guardar);
                    input.addEventListener('keydown', e => {
                        if (e.key === 'Enter') {
                            e.preventDefault();
                            input.blur();
                        }
                    });
                });
            });
        }

        function cssColorToHex(colorStr) {
            if (!colorStr) return '#000000';

            colorStr = colorStr.trim().toLowerCase();

            // #abc, #aabbcc, #rrggbbaa
            if (colorStr.startsWith('#')) {
                if (colorStr.length === 4) {
                    return '#' + [...colorStr.slice(1)].map(c => c + c).join('');
                }
                if (colorStr.length === 7) return colorStr;
                if (colorStr.length === 9) return '#' + colorStr.slice(1, 7); // descarta alfa
            }

            // rgb() o rgba()
            const m = colorStr.match(
                /^rgba?\(\s*([\d.]+)\s*[, ]\s*([\d.]+)\s*[, ]\s*([\d.]+)(?:\s*[,/]\s*([\d.]+))?\s*\)$/
            );
            if (m) {
                const toHex = n => Math.max(0, Math.min(255, Math.round(+n))).toString(16).padStart(2, '0');
                return '#' + toHex(m[1]) + toHex(m[2]) + toHex(m[3]);
            }

            // fallback
            return '#000000';
        }

        function update_color_element_bd_table(selector, tabla, datasetKey , estilos = [['-e-','backgroundColor', '-color-']] ) {
            document.querySelectorAll(selector).forEach(div => {
                div.style.position = 'relative';
                if (div.querySelector('.inputUpdateColor')) return; // evitar duplicados

                const id = div.dataset[datasetKey];
                const colorActual = cssColorToHexAdvanced(window.getComputedStyle(div).backgroundColor);

                const cdiv = document.createElement('div');
                cdiv.classList.add('btnUpdateColor');
                cdiv.style.position = 'relative';
                cdiv.style.display = 'inline-block';
                div.appendChild(cdiv);

                const input = document.createElement('input');
                input.type = 'color';
                input.value = colorActual;
                input.style.position = 'absolute';
                input.style.top = '0';
                input.style.left = '0';
                input.style.width = '100%';
                input.style.height = '100%';
                input.style.opacity = '0';
                input.style.cursor = 'pointer';
                input.style.zIndex = '2';
                input.dataset.id = id;
                cdiv.appendChild(input);

                const icon = document.createElement('i');
                icon.classList.add('iconUpdateColor', 'fa-solid', 'fa-palette');
                icon.style.position = 'relative';
                icon.style.zIndex = '1';
                icon.style.pointerEvents = 'none';
                cdiv.appendChild(icon);

                // Cuando el usuario elige un color
                input.addEventListener('input', () => {
                    const newColor = input.value;

                    estilos.forEach(ss => {
                        const val = ss[2].replace('-color-',newColor);
                        if (ss[0]=='-e-') {
                            div.style[ss[1]] = val;
                            ajustarColorTexto(div);
                        } else {
                            const elements = document.querySelectorAll( ss[0].replace('-id-',id) );
                            elements.forEach(element => {
                                element.style[ss[1]] = val;
                                ajustarColorTexto(element);
                            });
                        }
                    });

                    // actualizar en BD
                    update_column_table_id(tabla, "color", newColor, id);

                });
            });
        }

        function cssColorToHexAdvanced(color) {
            if (color.startsWith("color(srgb")) {
                // extraer números
                let parts = color.match(/[-+]?\d*\.?\d+/g).map(Number);
                // srgb está normalizado 0-1 → convierto a 0-255
                let r = Math.round(parts[0] * 255);
                let g = Math.round(parts[1] * 255);
                let b = Math.round(parts[2] * 255);

                return "#" + [r, g, b]
                    .map(x => x.toString(16).padStart(2, "0"))
                    .join("");
            }

            // fallback → usa canvas que soporta rgb(), hsl(), hex...
            let ctx = document.createElement("canvas").getContext("2d");
            ctx.fillStyle = color;
            return ctx.fillStyle;
        }

        function update_color_element_bd_where(selector, tabla, whereClause, datasetKeys , estilos = [['-e-','backgroundColor', '-color-']] ) {
            document.querySelectorAll(selector).forEach(div => {
                div.style.position = 'relative';
                if (div.querySelector('.inputUpdateColor')) return; // evitar duplicados

                const whereValues = datasetKeys.map(key => div.dataset[key]);
                const colorActual = cssColorToHexAdvanced(window.getComputedStyle(div).backgroundColor);
                // console.log('color',window.getComputedStyle(div).backgroundColor);
                // console.log('t',cssColorToHex(window.getComputedStyle(div).backgroundColor));
                const input = document.createElement('input');
                input.type = 'color';
                input.classList.add('inputUpdateColor');
                input.value = colorActual;
                div.appendChild(input);

                // Cuando el usuario elige un color
                input.addEventListener('input', () => {
                    const newColor = input.value;

                    // aplicar al div visible
                    estilos.forEach(ss => {
                        const val = ss[2].replace('-color-',newColor);
                        if (ss[0]=='-e-') {
                            div.style[ss[1]] = val;
                            ajustarColorTexto(div);
                        } else {
                            const elements = document.querySelectorAll( ss[0].replace('-id-',id) );
                            elements.forEach(element => {
                                element.style[ss[1]] = val;
                                ajustarColorTexto(element);
                            });
                        }
                    });

                    // actualizar en BD
                    update_bd_table(tabla, ["color"], [newColor], whereClause, whereValues);

                });
            });
        }
        
        async function api_check_tarea(id) {
            try {
                const response = await fetch('/api_check_tarea', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ id })
                });

                if (!response.ok) throw new Error("Error al actualizar");

                const data = await response.json();
                // console.log(data.estado);
                return data.estado;
            } catch (err) {
                console.error(err);
                alert("Error al actualizar valor");
                return null; // o lo que necesites
            }
        }

        function check_tareas(selector, datasetKey) {
            document.querySelectorAll(selector).forEach(div => {
                div.style.position = 'relative';
                const id = div.dataset[datasetKey];

                if (!div.querySelector('.buttonCheckTarea')) {

                    div.innerHTML += `
                    <div class="buttonCheckTarea" data-tareaid="${id}">
                        <i class="fa-solid fa-circle-check"></i>
                    </div>                
                    `;
                }

                div.querySelector('.buttonCheckTarea').addEventListener('click', async () => {
                    const rpta = await api_check_tarea(id);
                    if (rpta == 1) {
                        div.classList.add('tarea_completa');
                    } else {
                        div.classList.remove('tarea_completa');
                    }
                });
            });
        }

    
        
        
    
    </script>

    {% block scripts_html %}
    {% endblock %}

</body>

</html>